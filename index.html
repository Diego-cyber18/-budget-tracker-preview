<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nestly</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c162a;
      --card:#12203a;
      --text:#e9eefc;
      --muted:#aab6d6;
      --border:rgba(255,255,255,.10);
      --shadow:0 10px 35px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --gap:16px;
      --max:1200px;
      --accent:#6ea8ff;
      --accent2:#7cf0c6;
      --danger:#ff6b6b;
      --ok:#45d483;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(110,168,255,.28), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(124,240,198,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), #070b14 80%);
      color:var(--text);
    }

    a{ color:inherit; text-decoration:none; }
    button{ font:inherit; }

    .app{
      min-height:100%;
      padding:20px;
      display:flex;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:var(--max);
      display:flex;
      flex-direction:column;
      gap:var(--gap);
    }

    .topbar{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:220px;
    }
    .logo{
      width:42px; height:42px;
      border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.35), transparent 55%),
        linear-gradient(135deg, rgba(110,168,255,.9), rgba(124,240,198,.75));
      box-shadow:0 10px 25px rgba(110,168,255,.18);
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--border);
      color:var(--muted);
      font-size:13px;
    }

    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{
      background:rgba(255,255,255,.09);
      border-color:rgba(255,255,255,.16);
    }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{
      background:linear-gradient(135deg, rgba(110,168,255,.95), rgba(124,240,198,.75));
      color:#08101f;
      border-color:transparent;
      font-weight:650;
    }
    .btn.danger{
      background:rgba(255,107,107,.12);
      border-color:rgba(255,107,107,.25);
      color:#ffd2d2;
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      cursor:pointer;
      transition: background .15s ease, color .15s ease, border-color .15s ease;
      user-select:none;
    }
    .tab.active{
      background:rgba(110,168,255,.16);
      border-color:rgba(110,168,255,.35);
      color:var(--text);
    }

    .content{
      display:flex;
      flex-direction:column;
      gap:var(--gap);
    }

    /* LAYOUT RESPONSIVE VERO:
       - Mobile: 1 colonna
       - Desktop: griglia auto-fit con card che non si tagliano e restano centrate */
    .grid{
      width:100%;
      display:grid;
      grid-template-columns: 1fr;
      gap:var(--gap);
      align-items:stretch;
    }
    @media (min-width: 900px){
      .grid{
        grid-template-columns: repeat(12, 1fr);
      }
      .col-7{ grid-column: span 7; }
      .col-5{ grid-column: span 5; }
      .col-12{ grid-column: span 12; }
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .panel-header{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .panel-title{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:200px;
    }
    .panel-title h2{
      margin:0;
      font-size:15px;
      letter-spacing:.2px;
    }
    .panel-title p{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    .panel-body{
      padding:14px 16px 16px;
    }

    .card{
      background:linear-gradient(180deg, rgba(18,32,58,.85), rgba(12,22,42,.9));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius2);
      padding:14px;
    }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .kpi{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
      width:100%;
    }
    @media (min-width: 700px){
      .kpi{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    }
    .kpi .k{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px;
    }
    .k .label{ font-size:12px; color:var(--muted); }
    .k .value{ margin-top:6px; font-size:18px; font-weight:750; }

    .notice{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .notice.error{
      border-color:rgba(255,107,107,.25);
      background:rgba(255,107,107,.10);
      color:#ffd2d2;
    }

    .input, .select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--text);
      outline:none;
    }
    .input::placeholder{ color: rgba(233,238,252,.55); }

    .form{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 700px){
      .form{
        grid-template-columns: 1.2fr .8fr .8fr auto;
        align-items:end;
      }
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
    }
    .item-left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .item-title{
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item-sub{
      font-size:12px;
      color:var(--muted);
    }
    .amount{
      font-weight:800;
      white-space:nowrap;
    }

    .footer-space{ height:10px; }
  </style>
</head>

<body>
  <div id="root"></div>

  <!-- React -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel per JSX (ok per GitHub Pages) -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- Firebase compat (come nel tuo file) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ===== Firebase Init (la tua config) =====
    firebase.initializeApp({
      apiKey: "AIzaSyBDTMPfdMxsvstKYpvQh_95URYfN5JdzEE",
      authDomain: "moneypal-89fcf.firebaseapp.com",
      databaseURL: "https://moneypal-89fcf-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "moneypal-89fcf",
      storageBucket: "moneypal-89fcf.firebasestorage.app",
      messagingSenderId: "290834672771",
      appId: "1:290834672771:web:0e92b118cefea511a1bfb6"
    });

    const db = firebase.database();
    const auth = firebase.auth();

    // ===== Helpers =====
    function euro(n){
      const x = Number(n);
      if (!Number.isFinite(x)) return "‚Ç¨0";
      return x.toLocaleString("it-IT", { style:"currency", currency:"EUR" });
    }
    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    // ===== App =====
    function App(){
      const [user, setUser] = useState(null);
      const [authError, setAuthError] = useState("");
      const [activeTab, setActiveTab] = useState("casa"); // casa | bollette

      // Bollette (semplice base)
      const [billName, setBillName] = useState("");
      const [billAmount, setBillAmount] = useState("");
      const [billMonth, setBillMonth] = useState(() => {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      });
      const [bills, setBills] = useState([]);
      const [loadingBills, setLoadingBills] = useState(false);
      const [dataError, setDataError] = useState("");

      const uid = user?.uid || null;

      // ===== Auth listener =====
      useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => {
          setUser(u || null);
          setAuthError("");
        });
        return () => unsub && unsub();
      }, []);

      // ===== Load bills =====
      useEffect(() => {
        setDataError("");
        setBills([]);
        if (!uid) return;

        setLoadingBills(true);

        // Percorso DB: users/{uid}/bills/{YYYY-MM}
        const ref = db.ref(`users/${uid}/bills/${billMonth}`);

        const handler = snap => {
          const val = snap.val() || {};
          const arr = Object.entries(val).map(([id, it]) => ({
            id,
            name: it?.name || "Senza nome",
            amount: Number(it?.amount || 0),
            createdAt: it?.createdAt || ""
          }))
          .sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || ""));

          setBills(arr);
          setLoadingBills(false);
        };

        const err = e => {
          setDataError(String(e?.message || e || "Errore lettura DB"));
          setLoadingBills(false);
        };

        ref.on("value", handler, err);
        return () => ref.off("value", handler);
      }, [uid, billMonth]);

      const totalBills = useMemo(() => bills.reduce((s,x)=>s + (Number(x.amount)||0), 0), [bills]);

      async function doGoogleLogin(){
        setAuthError("");
        try{
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithPopup(provider);
        }catch(e){
          setAuthError(String(e?.message || e));
        }
      }

      async function doLogout(){
        setAuthError("");
        try{
          await auth.signOut();
        }catch(e){
          setAuthError(String(e?.message || e));
        }
      }

      async function addBill(){
        setDataError("");
        if (!uid) { setAuthError("Devi fare login"); return; }

        const name = billName.trim();
        const amount = Number(String(billAmount).replace(",", "."));

        if (!name) { setDataError("Inserisci un nome bolletta"); return; }
        if (!Number.isFinite(amount) || amount <= 0) { setDataError("Inserisci un importo valido"); return; }

        try{
          const ref = db.ref(`users/${uid}/bills/${billMonth}`).push();
          await ref.set({
            name,
            amount,
            createdAt: new Date().toISOString()
          });
          setBillName("");
          setBillAmount("");
        }catch(e){
          setDataError(String(e?.message || e || "Errore salvataggio"));
        }
      }

      async function deleteBill(id){
        setDataError("");
        if (!uid) return;
        try{
          await db.ref(`users/${uid}/bills/${billMonth}/${id}`).remove();
        }catch(e){
          setDataError(String(e?.message || e || "Errore eliminazione"));
        }
      }

      return (
        <div className="app">
          <div className="container">

            <div className="topbar">
              <div className="brand">
                <div className="logo" />
                <div>
                  <h1>Nestly</h1>
                  <p>GitHub Pages + Firebase</p>
                </div>
              </div>

              <div className="top-actions">
                <div className="pill">
                  {user ? (
                    <>
                      <span>üë§</span>
                      <span style={{maxWidth:220, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap"}}>
                        {user.displayName || user.email || "Utente"}
                      </span>
                    </>
                  ) : (
                    <>
                      <span>üîí</span><span>Non autenticato</span>
                    </>
                  )}
                </div>

                {!user ? (
                  <button className="btn primary" onClick={doGoogleLogin}>Login Google</button>
                ) : (
                  <button className="btn danger" onClick={doLogout}>Logout</button>
                )}
              </div>

              <div className="tabs" style={{width:"100%"}}>
                <div className={"tab " + (activeTab==="casa" ? "active" : "")} onClick={()=>setActiveTab("casa")}>
                  Casa
                </div>
                <div className={"tab " + (activeTab==="bollette" ? "active" : "")} onClick={()=>setActiveTab("bollette")}>
                  Bollette
                </div>
              </div>
            </div>

            {(authError || dataError) && (
              <div className={"notice " + ((authError || dataError) ? "error" : "")}>
                {authError ? `Auth: ${authError}` : ""}
                {authError && dataError ? " ‚Äî " : ""}
                {dataError ? `Dati: ${dataError}` : ""}
              </div>
            )}

            <div className="content">
              {activeTab === "casa" && (
                <div className="grid">
                  <div className="panel col-12">
                    <div className="panel-header">
                      <div className="panel-title">
                        <h2>Casa</h2>
                        <p>Sezione base pronta (layout desktop/mobile stabile)</p>
                      </div>
                    </div>
                    <div className="panel-body">
                      <div className="card">
                        <div className="notice">
                          Qui ci agganciamo dopo con le tue cose (spese, entrate, vault, ecc).  
                          Per ora √® solo la struttura pulita e responsive.
                        </div>
                        <div className="footer-space"></div>
                        <div className="kpi">
                          <div className="k">
                            <div className="label">Stato</div>
                            <div className="value">{user ? "Online" : "Login richiesto"}</div>
                          </div>
                          <div className="k">
                            <div className="label">Data</div>
                            <div className="value">{todayKey()}</div>
                          </div>
                          <div className="k">
                            <div className="label">Ambiente</div>
                            <div className="value">GitHub Pages</div>
                          </div>
                          <div className="k">
                            <div className="label">DB</div>
                            <div className="value">Firebase RTDB</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {activeTab === "bollette" && (
                <div className="grid">
                  <div className="panel col-7">
                    <div className="panel-header">
                      <div className="panel-title">
                        <h2>Bollette</h2>
                        <p>Responsive: su desktop non taglia e resta centrato</p>
                      </div>
                      <div style={{minWidth:220}}>
                        <input
                          className="input"
                          type="month"
                          value={billMonth}
                          onChange={(e)=>setBillMonth(e.target.value)}
                        />
                      </div>
                    </div>

                    <div className="panel-body">
                      <div className="card">
                        <div className="form">
                          <div>
                            <div style={{fontSize:12, color:"var(--muted)", marginBottom:6}}>Nome bolletta</div>
                            <input className="input" value={billName} onChange={e=>setBillName(e.target.value)} placeholder="Es. Luce, Gas, Internet" />
                          </div>
                          <div>
                            <div style={{fontSize:12, color:"var(--muted)", marginBottom:6}}>Importo</div>
                            <input className="input" value={billAmount} onChange={e=>setBillAmount(e.target.value)} placeholder="Es. 79.90" inputMode="decimal" />
                          </div>
                          <div>
                            <div style={{fontSize:12, color:"var(--muted)", marginBottom:6}}>Azione</div>
                            <button className="btn primary" onClick={addBill} style={{width:"100%"}}>
                              Aggiungi
                            </button>
                          </div>
                          <div>
                            <div style={{fontSize:12, color:"var(--muted)", marginBottom:6}}>Login</div>
                            {!user ? (
                              <button className="btn" onClick={doGoogleLogin} style={{width:"100%"}}>Login</button>
                            ) : (
                              <button className="btn danger" onClick={doLogout} style={{width:"100%"}}>Logout</button>
                            )}
                          </div>
                        </div>

                        <div className="footer-space"></div>

                        {!user && (
                          <div className="notice">
                            Fai login Google per vedere/salvare le bollette sul tuo database.
                          </div>
                        )}

                        {user && (
                          <>
                            <div className="row" style={{marginTop:6}}>
                              <div className="pill">Totale mese: <b style={{color:"var(--text)"}}>{euro(totalBills)}</b></div>
                              <div className="pill">Voci: <b style={{color:"var(--text)"}}>{bills.length}</b></div>
                            </div>

                            <div className="footer-space"></div>

                            {loadingBills ? (
                              <div className="notice">Caricamento‚Ä¶</div>
                            ) : (
                              <div className="list">
                                {bills.length === 0 ? (
                                  <div className="notice">Nessuna bolletta per questo mese.</div>
                                ) : bills.map(it => (
                                  <div className="item" key={it.id}>
                                    <div className="item-left">
                                      <div className="item-title">{it.name}</div>
                                      <div className="item-sub">{(it.createdAt || "").slice(0,10)}</div>
                                    </div>
                                    <div style={{display:"flex", alignItems:"center", gap:10}}>
                                      <div className="amount">{euro(it.amount)}</div>
                                      <button className="btn danger" onClick={()=>deleteBill(it.id)} title="Elimina">‚úï</button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </>
                        )}
                      </div>
                    </div>
                  </div>

                  <div className="panel col-5">
                    <div className="panel-header">
                      <div className="panel-title">
                        <h2>Note</h2>
                        <p>Questa colonna su desktop resta affiancata, su mobile va sotto</p>
                      </div>
                    </div>
                    <div className="panel-body">
                      <div className="card">
                        <div className="notice">
                          La sezione ‚ÄúProgetti‚Äù e ‚ÄúMutuo‚Äù √® stata rimossa completamente.  
                          Quando vuoi, la rifacciamo da zero MA con layout che non si taglia mai su desktop.
                        </div>
                        <div className="footer-space"></div>
                        <div className="notice">
                          Percorso DB usato qui: <b>users/{`{uid}`}/bills/{`{YYYY-MM}`}</b>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              )}
            </div>

          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
